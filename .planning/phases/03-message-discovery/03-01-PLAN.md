---
phase: 03-message-discovery
plan: "01"
type: tdd
wave: 1
depends_on: []
files_modified:
  - gmail_cleanup/date_utils.py
  - tests/test_date_utils.py
autonomous: true
requirements:
  - DISC-02

must_haves:
  truths:
    - "parse_date_to_cutoff('2024-01-01') returns a tz-aware datetime at 23:59:59 local time on 2024-01-01"
    - "months_ago_to_cutoff(6) returns a tz-aware datetime in local timezone (not UTC)"
    - "build_gmail_query returns 'before:EPOCH' with an integer Unix epoch, not a formatted date string"
    - "All 12 existing date_utils tests are updated to reflect new contracts and pass"
  artifacts:
    - path: "gmail_cleanup/date_utils.py"
      provides: "Timezone-correct date conversion and epoch-based Gmail query building"
      contains: "before:{int}"
    - path: "tests/test_date_utils.py"
      provides: "Updated test suite covering new local-tz and epoch contracts"
      contains: "before:"
  key_links:
    - from: "tests/test_date_utils.py"
      to: "gmail_cleanup/date_utils.py"
      via: "import parse_date_to_cutoff, months_ago_to_cutoff, build_gmail_query"
      pattern: "from gmail_cleanup.date_utils import"
    - from: "gmail_cleanup/date_utils.py"
      to: "Unix epoch integer"
      via: "int(dt.timestamp())"
      pattern: "int\\(.*\\.timestamp\\(\\)\\)"
---

<objective>
Upgrade date_utils.py to produce timezone-correct cutoffs and epoch-based Gmail queries.

Purpose: Phase 2's `before:YYYY/MM/DD` format is ambiguous at timezone boundaries — a date like 2024-01-01 resolves to UTC midnight, which is actually Dec 31 in PST. Gmail's `before:EPOCH` format with a Unix timestamp eliminates this ambiguity. The `--before` flag should mean "end of that day in local time."

Output: Updated `date_utils.py` with local-timezone semantics and epoch output; updated `tests/test_date_utils.py` with contracts matching new behavior.
</objective>

<execution_context>
@/Users/dalwrigh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dalwrigh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@gmail_cleanup/date_utils.py
@tests/test_date_utils.py
</context>

<feature>
  <name>Timezone-correct date cutoffs with Unix epoch Gmail queries</name>
  <files>gmail_cleanup/date_utils.py, tests/test_date_utils.py</files>
  <behavior>
    Three functions change contract:

    months_ago_to_cutoff(months: int) -> datetime
    - Was: UTC-aware datetime, UTC timezone
    - Now: local-tz-aware datetime (end-of-second precision, local timezone)
    - Use: datetime.now().astimezone() - relativedelta(months=months)
    - Keep: relativedelta for calendar-correct month arithmetic
    - Cases:
      months_ago_to_cutoff(6) -> tz-aware datetime, tzinfo is local tz (not UTC unless system is UTC)
      months_ago_to_cutoff(0) -> approximately now, local tz
      result is in the past -> True

    parse_date_to_cutoff(date_str: str) -> datetime
    - Was: UTC midnight (2024-01-01 00:00:00 UTC)
    - Now: end of that day in local timezone (2024-01-01 23:59:59 local)
    - Use: datetime.strptime(date_str, "%Y-%m-%d").replace(hour=23, minute=59, second=59).astimezone()
    - IMPORTANT: call .replace() BEFORE .astimezone() — set time components first, then attach local tz
    - Still raises ValueError for invalid input (strptime contract unchanged)
    - Cases:
      parse_date_to_cutoff("2024-01-01") -> datetime(2024, 1, 1, 23, 59, 59, tzinfo=local_tz)
      parse_date_to_cutoff("2024-06-15") -> datetime(2024, 6, 15, 23, 59, 59, tzinfo=local_tz)
      parse_date_to_cutoff("not-a-date") -> raises ValueError
      parse_date_to_cutoff("2024-13-01") -> raises ValueError
      parse_date_to_cutoff("01/01/2024") -> raises ValueError

    build_gmail_query(cutoff: datetime) -> str
    - Was: "before:YYYY/MM/DD" formatted date string
    - Now: "before:{epoch}" where epoch is int(cutoff.timestamp())
    - Cases:
      build_gmail_query(any_tz_aware_datetime) -> "before:NNNNNNNNNN" (10-digit integer)
      result.startswith("before:") -> True
      result[7:].isdigit() -> True (the epoch is a pure integer, no decimal point)
  </behavior>
  <implementation>
    RED phase: Update tests/test_date_utils.py first.

    For TestMonthsAgeToCutoff:
    - test_returns_utc_aware_datetime: change assertion — result should be tz-aware but NOT necessarily UTC. Check result.tzinfo is not None. Remove the UTC equality check.
    - test_result_is_in_the_past: keep, update comparison to use datetime.now().astimezone() instead of datetime.now(timezone.utc)
    - test_6_months_ago_has_correct_month_offset: update expected to use datetime.now().astimezone() - relativedelta(months=6)
    - test_zero_months_returns_approximately_now: update comparison to use datetime.now().astimezone()

    For TestParseDateToCutoff:
    - test_valid_date_returns_utc_midnight: rename and rewrite — now checks hour=23, minute=59, second=59, tzinfo is not None (not UTC-specific)
    - test_mid_year_date: rewrite — check hour=23, minute=59, second=59
    - test_invalid_* tests: keep as-is, ValueError contract unchanged

    For TestBuildGmailQuery:
    - test_formats_with_slashes_not_hyphens: replace entirely — now asserts "before:" prefix + integer epoch
    - test_zero_pads_month_and_day: no longer relevant — replace with test that result[7:] is a digit-only string
    - test_prefix_is_before: keep

    Add new tests:
    - test_epoch_is_integer_string: build_gmail_query(any_datetime) -> result[7:].isdigit() is True
    - test_before_end_of_day: parse_date_to_cutoff("2024-01-01").hour == 23 and .minute == 59 and .second == 59

    Run tests — they MUST fail at RED phase (commit as RED).

    GREEN phase: Update gmail_cleanup/date_utils.py:
    - months_ago_to_cutoff: change datetime.now(timezone.utc) to datetime.now().astimezone()
    - parse_date_to_cutoff: change to datetime.strptime(date_str, "%Y-%m-%d").replace(hour=23, minute=59, second=59).astimezone()
    - build_gmail_query: change to f"before:{int(cutoff.timestamp())}"
    - Update imports: remove timezone import if no longer needed (datetime.now().astimezone() does not need timezone.utc)
    - Update docstrings to reflect new behavior

    Run tests — they MUST pass at GREEN phase (commit as GREEN).

    REFACTOR: Update docstrings for clarity. No logic changes needed. Run tests again (commit as REFACTOR only if changes made).
  </implementation>
</feature>

<verification>
After GREEN phase:
- `uv run pytest tests/test_date_utils.py -v` passes all tests
- `python -c "from gmail_cleanup.date_utils import build_gmail_query, parse_date_to_cutoff; from datetime import datetime; c = parse_date_to_cutoff('2024-01-01'); print(build_gmail_query(c))"` prints `before:` followed by a 10-digit integer
- No naive datetime objects: `python -c "from gmail_cleanup.date_utils import months_ago_to_cutoff, parse_date_to_cutoff; assert months_ago_to_cutoff(1).tzinfo is not None; assert parse_date_to_cutoff('2024-01-01').tzinfo is not None; print('OK')"`
</verification>

<success_criteria>
- All tests in test_date_utils.py pass (updated count may differ but all green)
- build_gmail_query output matches pattern "before:\d+" (integer epoch, not formatted date)
- parse_date_to_cutoff("2024-01-01") returns datetime with hour=23, minute=59, second=59
- months_ago_to_cutoff(6) returns tz-aware datetime (tzinfo is not None)
- No import of timezone.utc remaining in date_utils.py (unless needed for another reason)
</success_criteria>

<output>
After completion, create `.planning/phases/03-message-discovery/03-01-SUMMARY.md`
</output>
