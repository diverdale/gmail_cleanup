---
phase: 03-message-discovery
plan: "03"
type: execute
wave: 2
depends_on:
  - "03-01"
  - "03-02"
files_modified:
  - gmail_cleanup/main.py
autonomous: false

requirements:
  - DISC-01
  - DISC-02

must_haves:
  truths:
    - "Dry-run output shows exact count with no ~ prefix and no '(approximate, up to 500 shown)' qualifier"
    - "Dry-run output shows resolved timestamp with timezone: e.g. 'Found 247 emails before 2024-01-01 23:59:59 PST'"
    - "A Rich spinner with running counter appears during fetch (including single-page results)"
    - "Spinner line is replaced by final count line when fetch completes"
    - "Mid-pagination API error exits with code 1 and error message including page number"
    - "All existing CLI behaviors preserved: --execute confirmation, cancel exits 0, credential errors"
  artifacts:
    - path: "gmail_cleanup/main.py"
      provides: "Wired CLI: epoch query, paginated fetch, spinner, exact count display"
      contains: "list_message_ids"
    - path: "gmail_cleanup/main.py"
      provides: "Rich spinner via console.status context manager"
      contains: "console.status"
  key_links:
    - from: "gmail_cleanup/main.py"
      to: "gmail_cleanup/gmail_client.list_message_ids"
      via: "import and call in main()"
      pattern: "list_message_ids"
    - from: "gmail_cleanup/main.py"
      to: "gmail_cleanup/date_utils.build_gmail_query"
      via: "build_gmail_query(cutoff) produces epoch query"
      pattern: "build_gmail_query"
    - from: "gmail_cleanup/main.py"
      to: "rich.console.Console.status"
      via: "with console.status(...) as status: status.update(...)"
      pattern: "console\\.status"
---

<objective>
Wire main.py to use paginated list_message_ids(), add Rich spinner, and update dry-run output format.

Purpose: Plans 03-01 and 03-02 upgraded the underlying functions. This plan wires them together in the CLI: the spinner shows progress during pagination, the final output shows an exact count with the resolved timestamp, and mid-pagination errors fail cleanly.

Output: Updated `main.py` with paginated fetch, Rich spinner, exact count display, and timezone-annotated output.
</objective>

<execution_context>
@/Users/dalwrigh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dalwrigh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@gmail_cleanup/main.py
@.planning/phases/03-message-discovery/03-01-SUMMARY.md
@.planning/phases/03-message-discovery/03-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire main.py with paginated fetch, spinner, and updated output</name>
  <files>gmail_cleanup/main.py</files>
  <action>
    Update gmail_cleanup/main.py with these specific changes:

    1. IMPORTS: Replace `from gmail_cleanup.gmail_client import count_messages` with `from gmail_cleanup.gmail_client import list_message_ids`. Add `from rich.console import Console` at the top. Add `console = Console()` as a module-level constant below the imports (before `app = typer.Typer(...)`).

    2. SPINNER + PAGINATED FETCH: Replace the `count = count_messages(service, query)` call and its HttpError handler with this pattern:
       ```python
       message_ids: list[str] = []
       try:
           with console.status("Scanning... 0 emails found", spinner="dots") as status:
               # Re-implement inline pagination here so we can update the spinner per page
               page_token = None
               page_num = 0
               while True:
                   page_num += 1
                   kwargs: dict = {"userId": "me", "q": query, "maxResults": 500}
                   if page_token:
                       kwargs["pageToken"] = page_token
                   try:
                       result = service.users().messages().list(**kwargs).execute()
                   except HttpError as exc:
                       typer.echo(
                           f"Error: Failed to fetch page {page_num} of results. {exc}. Try again.",
                           err=True,
                       )
                       raise typer.Exit(code=1)
                   message_ids.extend(m["id"] for m in result.get("messages", []))
                   status.update(f"Scanning... {len(message_ids):,} emails found")
                   page_token = result.get("nextPageToken")
                   if not page_token:
                       break
       except typer.Exit:
           raise  # re-raise Exit so typer handles it
       ```

       IMPORTANT: The inline pagination loop is intentional — main.py owns the spinner update, so it needs to drive pagination itself rather than delegating entirely to list_message_ids(). list_message_ids() remains useful for Phase 4 (deletion loop), but the dry-run path uses inline pagination for UX control. This is consistent with the user decision: "spinner appears for all fetches."

    3. COUNT VARIABLE: After the spinner block, `count = len(message_ids)`.

    4. CUTOFF DISPLAY: Build a human-readable cutoff string for output. After building `cutoff` from either branch:
       ```python
       cutoff_display = cutoff.strftime("%Y-%m-%d %H:%M:%S %Z").strip()
       ```
       Use `cutoff_display` in the output lines below.

    5. DRY-RUN OUTPUT: Replace the existing dry-run echo block:
       ```python
       if not execute:
           console.print(f"[bold]Found {count:,} emails[/bold] before {cutoff_display}.")
           typer.echo("Run with --execute to delete permanently.")
           raise typer.Exit(code=0)
       ```
       Note: use `console.print()` for the Rich-formatted count line. Keep `typer.echo()` for the follow-up plain line.

    6. EXECUTE-PATH OUTPUT: Replace the execute-path count echo:
       ```python
       typer.echo(f"Found {count:,} emails before {cutoff_display}.")
       ```
       No ~ prefix, no qualifier text.

    7. HttpError is already imported at the top of main.py — do NOT add a second import inside the loop. The existing top-level `from googleapiclient.errors import HttpError` import is sufficient.

    Preserve all other logic unchanged: mutual exclusion check, credential error handling, confirmation gate, cancel-exits-0, deletion stub.
  </action>
  <verify>
    `uv run python -m gmail_cleanup.main --help` shows usage without error.
    `uv run python -c "import gmail_cleanup.main"` imports without error.
    `uv run pytest tests/ -v` passes all tests (both test_date_utils.py and test_gmail_client.py).
  </verify>
  <done>
    main.py imports cleanly, spinner block present with console.status, output uses console.print with bold formatting, no ~ prefix, no "approximate" qualifier in any output line.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Live verification — spinner, exact count, timezone display</name>
  <action>Human verifies Phase 3 live against real Gmail account: spinner appears, count is exact (no ~), timestamp shows local timezone at 23:59:59.</action>
  <verify>
    Run these four commands against a real Gmail account:

    1. Spinner + exact count:
       `uv run gmail-clean --older-than 24`
       Expected: spinner appears, then `Found N emails before YYYY-MM-DD 23:59:59 TZ.` and `Run with --execute to delete permanently.`
       No ~ prefix. No "(approximate)" text. TZ = local timezone abbreviation (e.g. PST, EST).

    2. End-of-day timezone for --before:
       `uv run gmail-clean --before 2023-01-01`
       Expected: output contains `before 2023-01-01 23:59:59 TZ` (end of day, local tz, not UTC midnight).

    3. Execute path count format:
       `uv run gmail-clean --older-than 24 --execute`
       Expected: `Found N emails before YYYY-MM-DD 23:59:59 TZ.` then confirmation prompt. Answer N.

    4. Error handling still works:
       `uv run gmail-clean`
       Expected: `Error: Provide --older-than N (months) or --before YYYY-MM-DD.` exit 1.
  </verify>
  <done>User confirms: spinner visible, count exact (no ~ or "approximate"), timestamp shows 23:59:59 with local TZ abbreviation.</done>
</task>

</tasks>

<verification>
- `uv run pytest tests/ -v` all tests pass
- `uv run gmail-clean --older-than 24` output contains no "~" and no "approximate"
- Output line matches pattern: `Found N emails before YYYY-MM-DD HH:MM:SS TZ.`
- `uv run gmail-clean --before 2023-01-01` shows 23:59:59 in the timestamp (end of day, not midnight)
</verification>

<success_criteria>
- Spinner visible during fetch (confirmed by human)
- Count is exact — no tilde, no "(approximate, up to 500 shown)" qualifier
- Timestamp includes time and timezone abbreviation
- --before 2023-01-01 resolves to 23:59:59 local time (not 00:00:00 UTC)
- All prior CLI behaviors preserved (error cases, confirmation gate, cancel exits 0)
</success_criteria>

<output>
After completion, create `.planning/phases/03-message-discovery/03-03-SUMMARY.md`
</output>
