---
phase: 02-cli-and-dry-run
plan: "02"
type: execute
wave: 2
depends_on:
  - "02-01"
files_modified:
  - gmail_cleanup/gmail_client.py
  - gmail_cleanup/main.py
autonomous: true
requirements:
  - CLI-01
  - CLI-02
  - CLI-03
  - CLI-04

must_haves:
  truths:
    - "Running 'gmail-clean --older-than 6' prints a dry-run count line and exits 0"
    - "Running 'gmail-clean --before 2024-01-01' prints a dry-run count line and exits 0"
    - "Running 'gmail-clean' with no arguments prints an error and exits 1"
    - "Running 'gmail-clean --older-than 6 --before 2024-01-01' prints an error about mutual exclusion and exits 1"
    - "Running without --execute makes zero write/delete API calls"
    - "Running 'gmail-clean --older-than 6 --execute' shows confirmation prompt before any deletion"
    - "Passing an invalid date string like '--before notadate' prints a Typer error and exits 2"
  artifacts:
    - path: "gmail_cleanup/gmail_client.py"
      provides: "count_messages() function — approximate email count via Gmail API list endpoint"
      contains: "def count_messages"
    - path: "gmail_cleanup/main.py"
      provides: "Real CLI with --older-than, --before, --execute; dry-run default; confirmation gate"
      contains: "def main"
  key_links:
    - from: "gmail_cleanup/main.py"
      to: "gmail_cleanup/date_utils.py"
      via: "imports months_ago_to_cutoff, parse_date_to_cutoff, build_gmail_query"
      pattern: "from gmail_cleanup.date_utils import"
    - from: "gmail_cleanup/main.py"
      to: "gmail_cleanup/gmail_client.py"
      via: "calls count_messages(service, query) to get approximate email count"
      pattern: "count_messages\\(service"
    - from: "gmail_cleanup/gmail_client.py"
      to: "Gmail API users.messages.list"
      via: "service.users().messages().list(userId='me', q=query, maxResults=500)"
      pattern: "service\\.users\\(\\)\\.messages\\(\\)\\.list"
---

<objective>
Add count_messages() to gmail_client.py and replace the Phase 1 auth smoke-test in main.py with the real CLI: --older-than, --before, --execute arguments with dry-run default and confirmation gate.

Purpose: This is the core of Phase 2 — the user-facing CLI surface. After this plan, the tool is usable for previewing what would be deleted.
Output: A working gmail-clean command with dry-run output and --execute confirmation gate. No actual deletion occurs (cleaner.py is still a stub).
</objective>

<execution_context>
@/Users/dalwrigh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dalwrigh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@gmail_cleanup/auth.py
@gmail_cleanup/main.py
@gmail_cleanup/gmail_client.py
@gmail_cleanup/date_utils.py
@.planning/phases/02-cli-and-dry-run/02-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add count_messages() to gmail_client.py</name>
  <files>/Users/dalwrigh/dev/gmail_cleanup/gmail_cleanup/gmail_client.py</files>
  <action>
    Replace the contents of gmail_client.py with:

    ```python
    """Gmail API operations — count implemented in Phase 2, list/delete in Phase 3/4."""

    from googleapiclient.errors import HttpError


    def count_messages(service, query: str) -> int:
        """Return approximate count of messages matching query (up to 500).

        Uses a single API call with maxResults=500 — does not paginate.
        Phase 3 will replace this with full pagination for accurate counts over 500.

        Args:
            service: Authenticated Gmail API service object from build_gmail_service().
            query: Gmail search query string (e.g. "before:2024/01/01").

        Returns:
            Number of matching messages found (0-500).
        """
        result = service.users().messages().list(
            userId="me", q=query, maxResults=500
        ).execute()
        messages = result.get("messages", [])
        return len(messages)


    def list_messages(service, query: str, max_results: int = 500) -> list[dict]:
        """Return list of message dicts matching query. Stub — Phase 3."""
        raise NotImplementedError("Implemented in Phase 3")
    ```

    Key points:
    - count_messages() is separate from list_messages() — list_messages() remains a stub for Phase 3
    - Import HttpError at the top (it will be used in future phases; leave it for now)
    - The docstring explicitly notes this is approximate and Phase 3 replaces it
    - maxResults=500 is the API's single-call maximum
  </action>
  <verify>
    ```bash
    cd /Users/dalwrigh/dev/gmail_cleanup && uv run python -c "from gmail_cleanup.gmail_client import count_messages; print('import OK')"
    ```
    Should print: `import OK`
  </verify>
  <done>count_messages() importable from gmail_cleanup.gmail_client; list_messages() stub still raises NotImplementedError</done>
</task>

<task type="auto">
  <name>Task 2: Replace main.py with real CLI</name>
  <files>/Users/dalwrigh/dev/gmail_cleanup/gmail_cleanup/main.py</files>
  <action>
    Replace the entire contents of main.py with the real CLI implementation:

    ```python
    """Gmail Cleanup CLI — delete old Gmail messages from the command line."""

    from typing import Optional

    import typer
    from googleapiclient.errors import HttpError

    from gmail_cleanup.auth import build_gmail_service
    from gmail_cleanup.date_utils import (
        build_gmail_query,
        months_ago_to_cutoff,
        parse_date_to_cutoff,
    )
    from gmail_cleanup.gmail_client import count_messages

    app = typer.Typer(
        name="gmail-clean",
        help="Delete old Gmail messages from the command line.",
        add_completion=False,
    )


    def validate_date(value: Optional[str]) -> Optional[str]:
        """Validate --before argument is YYYY-MM-DD format."""
        if value is None:
            return None
        try:
            parse_date_to_cutoff(value)
        except ValueError:
            raise typer.BadParameter(f"Date must be YYYY-MM-DD, got: {value}")
        return value


    @app.command()
    def main(
        older_than: Optional[int] = typer.Option(
            None,
            "--older-than",
            help="Target emails older than N months.",
            min=1,
        ),
        before: Optional[str] = typer.Option(
            None,
            "--before",
            help="Target emails before YYYY-MM-DD.",
            callback=validate_date,
            is_eager=False,
        ),
        execute: bool = typer.Option(
            False,
            "--execute",
            help="Perform live deletion. Dry-run is the default.",
        ),
    ) -> None:
        """Delete old Gmail messages. Runs in dry-run mode by default.

        Exactly one of --older-than or --before must be provided.
        Pass --execute to perform live deletion after confirmation.
        """
        # Mutual exclusion: require exactly one targeting argument
        if older_than is None and before is None:
            typer.echo(
                "Error: Provide --older-than N (months) or --before YYYY-MM-DD.",
                err=True,
            )
            raise typer.Exit(code=1)
        if older_than is not None and before is not None:
            typer.echo(
                "Error: Use --older-than or --before, not both.",
                err=True,
            )
            raise typer.Exit(code=1)

        # Build Gmail query from CLI argument
        if older_than is not None:
            cutoff = months_ago_to_cutoff(older_than)
        else:
            cutoff = parse_date_to_cutoff(before)  # type: ignore[arg-type]

        query = build_gmail_query(cutoff)

        # Authenticate and count matching messages
        try:
            service = build_gmail_service()
        except FileNotFoundError as exc:
            typer.echo(f"Error: credentials.json not found — {exc}", err=True)
            raise typer.Exit(code=1)

        try:
            count = count_messages(service, query)
        except HttpError as exc:
            typer.echo(f"Gmail API error: {exc}", err=True)
            raise typer.Exit(code=1)

        if not execute:
            # Dry-run: show count and exit — zero write/delete API calls made
            typer.echo(
                f"[DRY RUN] Found ~{count} emails matching '{query}' "
                f"(approximate, up to 500 shown)."
            )
            typer.echo("Run with --execute to delete permanently.")
            raise typer.Exit(code=0)

        # --execute path: show count and require explicit confirmation
        # typer.confirm() appends " [y/N]: " automatically — do not include in message
        typer.echo(f"Found ~{count} emails matching '{query}' (approximate, up to 500 shown).")
        try:
            confirmed = typer.confirm("Delete permanently")
        except (KeyboardInterrupt, typer.Abort):
            typer.echo("\nCancelled.")
            raise typer.Exit(code=0)

        if not confirmed:
            typer.echo("Deletion cancelled.")
            raise typer.Exit(code=0)

        # Deletion stub — Phase 4 implements batch_delete
        typer.echo("Deletion not yet implemented. (Phase 4)")
        raise typer.Exit(code=0)


    if __name__ == "__main__":
        app()
    ```

    Key implementation notes:
    - `--older-than` uses `min=1` so Typer rejects 0 or negative values automatically
    - `validate_date` callback runs on `--before` value before `main()` body executes
    - Mutual exclusion checked FIRST in function body (before any API calls)
    - Dry-run path: only calls `service.users().messages().list()` (read-only). Zero write/delete calls.
    - `--execute` path: calls `typer.confirm()` which adds "[y/N]" automatically — do NOT include in the message string passed to it
    - Cancel on "N": uses `raise typer.Exit(code=0)` not `raise typer.Abort()` — user cancelled intentionally, not an error
    - Ctrl-C: caught as `KeyboardInterrupt` or `typer.Abort`, exits 0 with "\nCancelled."
    - Deletion stub prints "(Phase 4)" so it's clear what's missing
  </action>
  <verify>
    ```bash
    cd /Users/dalwrigh/dev/gmail_cleanup

    # Test: no arguments → error
    uv run gmail-clean 2>&1; echo "Exit: $?"
    # Expected: "Error: Provide --older-than N (months) or --before YYYY-MM-DD." + Exit: 1

    # Test: both arguments → error
    uv run gmail-clean --older-than 6 --before 2024-01-01 2>&1; echo "Exit: $?"
    # Expected: "Error: Use --older-than or --before, not both." + Exit: 1

    # Test: invalid date format → Typer error
    uv run gmail-clean --before notadate 2>&1; echo "Exit: $?"
    # Expected: "Invalid value for '--before': Date must be YYYY-MM-DD, got: notadate" + Exit: 2

    # Test: help text
    uv run gmail-clean --help
    # Expected: shows --older-than, --before, --execute options

    # Test: dry-run with --older-than (requires live auth — run if token exists)
    uv run gmail-clean --older-than 6
    # Expected: "[DRY RUN] Found ~N emails matching 'before:YYYY/MM/DD' (approximate, up to 500 shown)."
    # Expected: "Run with --execute to delete permanently."
    ```
  </verify>
  <done>
    - No-argument invocation exits 1 with error message
    - Both-arguments invocation exits 1 with mutual exclusion error
    - Invalid --before date exits 2 with Typer BadParameter message
    - --older-than N with valid auth prints dry-run count line and exits 0
    - --before YYYY-MM-DD with valid auth prints dry-run count line and exits 0
    - --execute path shows confirmation prompt (verified in Plan 02-03 human checkpoint)
  </done>
</task>

</tasks>

<verification>
Run all offline checks first (no auth required):

```bash
cd /Users/dalwrigh/dev/gmail_cleanup

# Import checks
uv run python -c "from gmail_cleanup.gmail_client import count_messages; print('count_messages OK')"
uv run python -c "from gmail_cleanup.main import app; print('main import OK')"

# Argument validation (no auth needed)
uv run gmail-clean 2>&1 | grep "Error:"
uv run gmail-clean --older-than 6 --before 2024-01-01 2>&1 | grep "Error:"
uv run gmail-clean --before notadate 2>&1 | grep "YYYY-MM-DD"

# Run existing tests (date_utils from Plan 01)
uv run pytest tests/test_date_utils.py -v
```

All offline checks must pass before proceeding to Plan 02-03 (human verify).
</verification>

<success_criteria>
- count_messages() in gmail_client.py: calls list with maxResults=500, returns len(messages)
- main.py: --older-than, --before, --execute options present with correct types
- Mutual exclusion enforced: both args → exit 1, neither args → exit 1
- validate_date callback rejects non-YYYY-MM-DD strings with BadParameter
- Dry-run output: "[DRY RUN] Found ~N emails matching 'before:...' (approximate, up to 500 shown)."
- --execute path: typer.confirm() called with message "Delete permanently" (no "[y/N]" in string)
- Cancel via N or Ctrl-C: exits 0 (not error)
- Zero write/delete API calls in dry-run path (only .list() called)
- uv run pytest tests/test_date_utils.py passes (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/02-cli-and-dry-run/02-02-SUMMARY.md`
</output>
