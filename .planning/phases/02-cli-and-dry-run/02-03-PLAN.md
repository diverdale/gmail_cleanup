---
phase: 02-cli-and-dry-run
plan: "03"
type: execute
wave: 3
depends_on:
  - "02-02"
files_modified: []
autonomous: false
requirements:
  - CLI-03
  - CLI-04

must_haves:
  truths:
    - "gmail-clean --older-than 6 prints dry-run count against live Gmail and exits 0"
    - "gmail-clean --before 2024-01-01 prints dry-run count against live Gmail and exits 0"
    - "gmail-clean --older-than 1 --execute shows 'Delete permanently? [y/N]' prompt"
    - "Answering N to confirmation exits 0 with 'Deletion cancelled.'"
    - "Ctrl-C at confirmation exits 0 with 'Cancelled.'"
  artifacts:
    - path: "gmail_cleanup/main.py"
      provides: "Verified CLI — dry-run output and --execute confirmation gate confirmed live"
      contains: "def main"
  key_links:
    - from: "gmail-clean (CLI)"
      to: "Gmail API"
      via: "count_messages() making read-only list call"
      pattern: "Found ~.*emails"
---

<objective>
Human-verify the complete Phase 2 CLI against the live Gmail API: both dry-run modes and the --execute confirmation gate.

Purpose: Ensures the tool works end-to-end against real Gmail data before Phase 2 is declared complete. Dry-run correctness and the confirmation gate are the core Phase 2 deliverables — they must be confirmed live, not just in unit tests.
Output: Phase 2 confirmed complete. No code changes.
</objective>

<execution_context>
@/Users/dalwrigh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dalwrigh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-cli-and-dry-run/02-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Pre-flight checks before human verification</name>
  <files></files>
  <action>
    Run offline validation to confirm the CLI is ready for live testing:

    ```bash
    cd /Users/dalwrigh/dev/gmail_cleanup

    # 1. All unit tests pass
    uv run pytest tests/test_date_utils.py -v

    # 2. Import chain is clean
    uv run python -c "
    from gmail_cleanup.date_utils import months_ago_to_cutoff, parse_date_to_cutoff, build_gmail_query
    from gmail_cleanup.gmail_client import count_messages
    from gmail_cleanup.main import app
    print('All imports OK')
    "

    # 3. Argument validation works without auth
    uv run gmail-clean 2>&1
    echo "---"
    uv run gmail-clean --older-than 6 --before 2024-01-01 2>&1
    echo "---"
    uv run gmail-clean --before notadate 2>&1

    # 4. Confirm token exists (if not, instruct user to run gmail-clean --older-than 1 to trigger OAuth)
    ls ~/.config/gmail-clean/token.json 2>/dev/null && echo "Token: present" || echo "Token: MISSING — OAuth required"
    ```

    If token is missing, print:
    "Token not found. Run `uv run gmail-clean --older-than 1` to trigger the OAuth browser flow first."

    If all checks pass, print:
    "Pre-flight complete. Ready for human verification."
  </action>
  <verify>
    - `uv run pytest tests/test_date_utils.py -v` exits 0
    - All imports succeed
    - `uv run gmail-clean` (no args) exits 1 with error message
    - `uv run gmail-clean --older-than 6 --before 2024-01-01` exits 1 with mutual exclusion error
    - `uv run gmail-clean --before notadate` exits 2 with YYYY-MM-DD error
    - Token exists at ~/.config/gmail-clean/token.json
  </verify>
  <done>All offline checks pass and OAuth token is present — ready for live verification.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Live CLI verification — dry-run and --execute confirmation gate</name>
  <action>
    Present the following 4 tests to the user for manual verification against the live Gmail API.
    Claude cannot perform these tests autonomously because they require interactive terminal input (Ctrl-C, "N" at prompt) and live Gmail credentials.
  </action>
  <what-built>
    Full Phase 2 CLI: --older-than, --before, --execute arguments with dry-run default and confirmation gate.
    Plans 02-01 and 02-02 implemented date utilities (with tests), count_messages(), and the real main.py CLI.
  </what-built>
  <how-to-verify>
    Run each command below and confirm the expected output. The tool must be run from the project directory:

    ```bash
    cd /Users/dalwrigh/dev/gmail_cleanup
    ```

    **Test 1: Dry-run with --older-than**
    ```bash
    uv run gmail-clean --older-than 6
    ```
    Expected:
    - Prints: `[DRY RUN] Found ~N emails matching 'before:YYYY/MM/DD' (approximate, up to 500 shown).`
    - Prints: `Run with --execute to delete permanently.`
    - Exits 0 (no error)

    **Test 2: Dry-run with --before**
    ```bash
    uv run gmail-clean --before 2024-01-01
    ```
    Expected:
    - Prints: `[DRY RUN] Found ~N emails matching 'before:2024/01/01' (approximate, up to 500 shown).`
    - Prints: `Run with --execute to delete permanently.`
    - Exits 0 (no error)

    **Test 3: --execute shows confirmation prompt, cancel with N**
    ```bash
    uv run gmail-clean --older-than 1 --execute
    ```
    Expected:
    - Prints count line (without [DRY RUN] prefix)
    - Shows prompt: `Delete permanently [y/N]: `
    - Type `N` and press Enter
    - Prints: `Deletion cancelled.`
    - Exits 0

    **Test 4: --execute with Ctrl-C**
    ```bash
    uv run gmail-clean --older-than 1 --execute
    ```
    Expected:
    - At the `Delete permanently [y/N]: ` prompt, press Ctrl-C
    - Prints: `Cancelled.`
    - Exits 0 (not an error exit)

    Report any output that does not match, or type "approved" if all 4 tests pass.
  </how-to-verify>
  <verify>User has confirmed all 4 tests produce expected output.</verify>
  <done>User types "approved" after all 4 tests pass.</done>
  <resume-signal>Type "approved" if all 4 tests pass, or describe what failed.</resume-signal>
</task>

</tasks>

<verification>
Phase 2 success criteria from ROADMAP.md:

1. `gmail-clean --older-than 6` runs without error and reports how many emails match (dry-run output) — confirmed by Test 1
2. `gmail-clean --before 2024-01-01` runs without error and reports how many emails match (dry-run output) — confirmed by Test 2
3. Running the tool without `--execute` makes zero write/delete API calls — confirmed by dry-run architecture (only .list() called)
4. Passing `--execute` displays "Found N emails. Delete permanently? [y/N]" and cancels cleanly on "N" or Ctrl-C — confirmed by Tests 3 and 4
</verification>

<success_criteria>
- All 4 human-verify tests produce expected output
- Dry-run count appears for both --older-than and --before
- --execute confirmation prompt appears with correct message format
- Cancel (N) and Ctrl-C both exit 0 without error
- Phase 2 declared complete after human approval
</success_criteria>

<output>
After completion, create `.planning/phases/02-cli-and-dry-run/02-03-SUMMARY.md`
</output>
