---
phase: 04-deletion
plan: "02"
type: execute
wave: 2
depends_on:
  - "04-01"
files_modified:
  - gmail_cleanup/main.py
autonomous: false
requirements:
  - DEL-04
  - DEL-03

must_haves:
  truths:
    - "Running with --execute and confirming 'y' deletes emails and prints count + elapsed time"
    - "Running in dry-run mode (no --execute) prints count and elapsed scan time"
    - "The deleted count printed after execution matches the count shown before confirmation"
    - "After deletion completes, output line reads: Deleted N,NNN emails in X.Xs"
    - "Dry-run output includes elapsed time: Found N,NNN emails in X.Xs (dry run)"
  artifacts:
    - path: "gmail_cleanup/main.py"
      provides: "Wired main() calling batch_delete() with elapsed timer"
      contains: "batch_delete"
  key_links:
    - from: "gmail_cleanup/main.py"
      to: "gmail_cleanup/cleaner.batch_delete"
      via: "import and direct call after confirmation"
      pattern: "from gmail_cleanup.cleaner import batch_delete"
    - from: "gmail_cleanup/main.py"
      to: "time.monotonic"
      via: "elapsed timer wrapping both scan and delete operations"
      pattern: "time\\.monotonic"
---

<objective>
Wire main.py: replace the Phase 4 stub with a real batch_delete() call, add elapsed timer to both dry-run and execute paths, and human-verify the full live deletion flow.

Purpose: Completes the tool end-to-end. Without this wiring, batch_delete() exists but is never called.
Output: Fully functional gmail-clean --execute command with progress, count, and elapsed time.
</objective>

<execution_context>
@/Users/dalwrigh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dalwrigh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@gmail_cleanup/main.py
@gmail_cleanup/cleaner.py
@.planning/phases/04-deletion/04-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire batch_delete and elapsed timer into main.py</name>
  <files>gmail_cleanup/main.py</files>
  <action>
    Edit main.py to wire the complete Phase 4 execution path. Four changes required:

    1. ADD imports at top of file (alongside existing imports):
       ```python
       import time
       from gmail_cleanup.cleaner import batch_delete
       ```

    2. START the elapsed timer BEFORE the scanning block (before the `console.status(...)` call):
       ```python
       start_time = time.monotonic()
       ```

    3. REPLACE the dry-run output block (currently two lines ending in `raise typer.Exit(code=0)`)
       with elapsed-aware output:
       ```python
       if not execute:
           elapsed = time.monotonic() - start_time
           console.print(
               f"[bold]Found {count:,} emails[/bold] before {cutoff_display} "
               f"[dim]({elapsed:.1f}s, dry run)[/dim]"
           )
           typer.echo("Run with --execute to delete permanently.")
           raise typer.Exit(code=0)
       ```

    4. REPLACE the deletion stub block (currently `typer.echo("Deletion not yet implemented...")`)
       with the live deletion path:
       ```python
       deleted = batch_delete(service, message_ids)
       elapsed = time.monotonic() - start_time
       console.print(
           f"[bold green]Deleted {deleted:,} emails[/bold green] "
           f"in [bold]{elapsed:.1f}s[/bold]."
       )
       ```

    Constraints:
    - start_time must be set BEFORE the scan loop — elapsed covers the full operation (scan + delete)
    - console = Console() already at module level — do NOT add another instance
    - message_ids is the list already collected by the scan loop — do NOT re-fetch
    - The typer.confirm() block and Cancel/N handling remain unchanged
    - batch_delete() returns int (deleted count) — use that value directly in the output line
  </action>
  <verify>
    uv run python -c "from gmail_cleanup.main import app; print('import OK')"
    uv run gmail-clean --older-than 1 (dry-run — confirm output includes elapsed time)
  </verify>
  <done>
    - Dry-run prints: "Found N,NNN emails before CUTOFF (X.Xs, dry run)"
    - Import succeeds with no errors
    - No NotImplementedError or stub comment remains in main.py
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Human-verify full deletion pipeline against live Gmail</name>
  <action>Pause for human verification of the complete deletion flow end-to-end.</action>
  <what-built>
    Full deletion pipeline: main.py wired to batch_delete(), elapsed timer on both dry-run
    and execute paths, Rich progress bar during deletion, count + elapsed summary after.
  </what-built>
  <how-to-verify>
    Step 1 — Dry-run with elapsed time:
      Run: gmail-clean --older-than 1
      Expected: "Found N,NNN emails before CUTOFF (X.Xs, dry run)"
      Expected: "Run with --execute to delete permanently."

    Step 2 — Live deletion (USE A SMALL/SAFE QUERY):
      Choose a small set (e.g., a label you're OK deleting, or --before 2010-01-01 if you have old mail).
      Run: gmail-clean --older-than 12 --execute   (or a date-bounded query you're comfortable with)
      Expected sequence:
        a. Spinner shows "Scanning... N emails found"
        b. "Found N emails before CUTOFF."
        c. "Delete permanently [y/N]: " prompt
        d. After typing 'y': Rich progress bar shows "Deleting... X/Y"
        e. After completion: "Deleted N emails in X.Xs."

    Step 3 — Count consistency (DEL-04):
      The N in step 2c (before confirmation) must equal the N in step 2e (deleted count).

    Step 4 — Cancel still exits 0:
      Run: gmail-clean --older-than 1 --execute
      Type 'n' at the prompt.
      Expected: "Deletion cancelled." — exits with code 0.
  </how-to-verify>
  <verify>All four steps produce expected output.</verify>
  <done>Full end-to-end flow verified: dry-run elapsed, deletion progress, count consistency, cancel exits 0.</done>
  <resume-signal>Type "approved" if all steps pass, or describe any issues observed.</resume-signal>
</task>

</tasks>

<verification>
- uv run pytest tests/ -v — full test suite passes (no regressions)
- gmail-clean --older-than 1 shows elapsed time in dry-run output
- gmail-clean --older-than 1 --execute confirms then deletes with progress and count+elapsed summary
- Deleted count matches found count (DEL-04)
- Cancel exits 0 (unchanged behavior from Phase 2)
</verification>

<success_criteria>
- Dry-run output includes elapsed scan time
- --execute path: progress bar visible during deletion, summary shows deleted count + elapsed
- Deleted count equals found count shown before confirmation
- Full test suite passes with no regressions
- Tool exits 0 on cancel (unchanged)
</success_criteria>

<output>
After completion, create `.planning/phases/04-deletion/04-02-SUMMARY.md`
</output>
